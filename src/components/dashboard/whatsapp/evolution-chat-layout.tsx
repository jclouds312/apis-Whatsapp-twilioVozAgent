\'use client\';\n\nimport React, { useState, useEffect } from \'react\';\nimport { ResizableHandle, ResizablePanel, ResizablePanelGroup } from \"@/components/ui/resizable\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Send, Paperclip, Mic, Smile } from \"lucide-react\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/components/ui/use-toast\";\n\n// Types matching the Evolution API response\ntype Chat = {\n    jid: string;\n    name: string;\n    t: number; // timestamp\n    unreadCount: number;\n    messages?: Message[];\n};\n\ntype Message = {\n    key: { remoteJid: string, fromMe: boolean, id: string };\n    messageTimestamp: number;\n    message?: { conversation?: string };\n};\n\nasync function fetchFromEvolutionAPI(endpoint: string, apiKey: string, instanceName: string, options: RequestInit = {}) {\n    const url = `/api/evolution/${endpoint}`;\n    const response = await fetch(url, {\n        ...options,\n        headers: {\n            ...options.headers,\n            \'Authorization\': `Bearer ${apiKey}`,\n            \'X-Instance-Name\': instanceName\n        },\n    });\n    if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.error || \'An API error occurred\');\n    }\n    return response.json();\n}\n\nexport function EvolutionChatLayout({ apiKey, instanceName }: { apiKey: string, instanceName: string }) {\n    const [chats, setChats] = useState<Chat[]>([]);\n    const [selectedChat, setSelectedChat] = useState<Chat | null>(null);\n    const [messages, setMessages] = useState<Message[]>([]);\n    const [newMessage, setNewMessage] = useState(\"\");\n    const { toast } = useToast();\n\n    useEffect(() => {\n        if (apiKey && instanceName) {\n            fetchChats();\n        }\n    }, [apiKey, instanceName]);\n\n    const fetchChats = async () => {\n        try {\n            const data = await fetchFromEvolutionAPI(\`chat/findChats/${instanceName}\`, apiKey, instanceName);\n            setChats(data || []);\n        } catch (error: any) {\n            toast({ title: \"Error fetching chats\", description: error.message, variant: \"destructive\" });\n        }\n    };\n\n    const fetchMessages = async (jid: string) => {\n        try {\n            const data = await fetchFromEvolutionAPI(`chat/findMessages/${instanceName}?jid=${jid}`, apiKey, instanceName);\n            setMessages(data || []);\n        } catch (error: any) {\n            toast({ title: \"Error fetching messages\", description: error.message, variant: \"destructive\" });\n        }\n    };\n    \n    const handleSendMessage = async () => {\n        if (!newMessage.trim() || !selectedChat) return;\n        try {\n            await fetchFromEvolutionAPI(\`message/sendText/${instanceName}\`, apiKey, instanceName, {\n                method: \'POST\',\n                headers: { \'Content-Type\': \'application/json\' },\n                body: JSON.stringify({ number: selectedChat.jid, textMessage: { text: newMessage } })\n            });\n            setNewMessage(\"\");\n            // Refresh messages after sending\n            setTimeout(() => fetchMessages(selectedChat.jid), 1000); \n        } catch (error: any) { \n            toast({ title: \"Error sending message\", description: error.message, variant: \"destructive\" });\n        }\n    };\n\n    useEffect(() => {\n        if (selectedChat) {\n            fetchMessages(selectedChat.jid);\n        }\n    }, [selectedChat]);\n\n    return (\n        <ResizablePanelGroup direction=\"horizontal\" className=\"h-full w-full rounded-lg border\">\n            <ResizablePanel defaultSize={25} minSize={20}>\n                <div className=\"p-4\">\n                    <h2 className=\"text-lg font-semibold\">Conversations</h2>\n                </div>\n                <ScrollArea className=\"h-[calc(100%-4rem)]\">\n                    {chats.map(chat => (\n                        <div key={chat.jid} \n                             className={`flex items-center gap-3 p-3 cursor-pointer ${selectedChat?.jid === chat.jid ? \'bg-muted\' : \'hover:bg-muted/50\'}`}\n                             onClick={() => setSelectedChat(chat)}>\n                             <Avatar className=\"h-10 w-10 border\">\n                                <AvatarImage src={`https://picsum.photos/seed/${chat.jid}/100/100`} alt={chat.name} />\n                                <AvatarFallback>{chat.name[0] || \'U\'}</AvatarFallback>\n                            </Avatar>\n                            <div className=\"flex-1\">\n                                <p className=\"font-medium truncate\">{chat.name || chat.jid}</p>\n                                <p className=\"text-xs text-muted-foreground truncate\">{/* Last message preview */}</p>\n                            </div>\n                            {chat.unreadCount > 0 && <Badge>{chat.unreadCount}</Badge>}\n                        </div>\n                    ))}\n                </ScrollArea>\n            </ResizablePanel>\n            <ResizableHandle withHandle />\n            <ResizablePanel defaultSize={75}>\n                {selectedChat ? (\n                    <div className=\"flex flex-col h-full\">\n                        <div className=\"flex items-center gap-4 p-4 border-b\">\n                            <Avatar className=\"h-10 w-10 border\">\n                                <AvatarImage src={`https://picsum.photos/seed/${selectedChat.jid}/100/100`} alt={selectedChat.name} />\n                                <AvatarFallback>{selectedChat.name[0] || \'U\'}</AvatarFallback>\n                            </Avatar>\n                            <h3 className=\"text-lg font-semibold\">{selectedChat.name || selectedChat.jid}</h3>\n                        </div>\n                        <ScrollArea className=\"flex-1 p-4\">\n                            <div className=\"space-y-4\">\n                                {messages.map(msg => (\n                                    <div key={msg.key.id} className={`flex ${msg.key.fromMe ? \'justify-end\' : \'justify-start\'}`}>\n                                        <div className={`rounded-lg px-4 py-2 max-w-sm ${msg.key.fromMe ? \'bg-primary text-primary-foreground\' : \'bg-muted\'}`}>\n                                            {msg.message?.conversation}\n                                        </div>\n                                    </div>\n                                ))}\n                            </div>\n                        </ScrollArea>\n                        <div className=\"p-4 border-t flex items-center gap-2\">\n                            <Button variant=\"outline\" size=\"icon\"><Paperclip className=\"h-5 w-5\" /></Button>\n                            <Input \n                                placeholder=\"Type a message...\" \n                                className=\"flex-1\" \n                                value={newMessage} \n                                onChange={e => setNewMessage(e.target.value)} \n                                onKeyPress={e => e.key === \'Enter\' && handleSendMessage()}/>\n                            <Button variant=\"outline\" size=\"icon\"><Smile className=\"h-5 w-5\" /></Button>\n                            <Button onClick={handleSendMessage}><Send className=\"h-5 w-5\" /></Button>\n                        </div>\n                    </div>\n                ) : (\n                    <div className=\"flex h-full items-center justify-center bg-muted/50\">\n                        <p>Select a conversation to start chatting</p>\n                    </div>\n                )}\n            </ResizablePanel>\n        </ResizablePanelGroup>\n    );\n}\n