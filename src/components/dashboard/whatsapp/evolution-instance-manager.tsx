\'use client\';\n\nimport { useState, useEffect } from \'react\';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \'@/components/ui/card\';\nimport { Button } from \'@/components/ui/button\';\nimport { Input } from \'@/components/ui/input\';\nimport { Label } from \'@/components/ui/label\';\nimport { useToast } from \"@/components/ui/use-toast\"\nimport { Badge } from \'@/components/ui/badge\';\nimport { Loader2, Power, QrCode, Trash2 } from \'lucide-react\';\n\n// Define types for the instance data\ntype Instance = {\n    instance: {\n        instanceName: string;\n        status: string;\n        owner: string;\n    }\n};\n\nasync function fetchFromEvolutionAPI(endpoint: string, apiKey: string, options: RequestInit = {}) {\n    const url = `/api/evolution/${endpoint}`;\n    const response = await fetch(url, {\n        ...options,\n        headers: {\n            ...options.headers,\n            \'Authorization\': `Bearer ${apiKey}`,\n        },\n    });\n    if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.error || \'An API error occurred\');\n    }\n    return response.json();\n}\n\nexport function EvolutionInstanceManager() {\n    const [apiKey, setApiKey] = useState(\'\');\n    const [instanceName, setInstanceName] = useState(\'\');\n    const [instances, setInstances] = useState<Instance[]>([]);\n    const [isLoading, setIsLoading] = useState(false);\n    const [qrCode, setQrCode] = useState(\'\');\n    const [isInstanceLoading, setIsInstanceLoading] = useState<Record<string, boolean>>({});\n    const { toast } = useToast();\n\n    const fetchInstances = async () => {\n        if (!apiKey) return;\n        setIsLoading(true);\n        try {\n            const data = await fetchFromEvolutionAPI(\'instance/fetchInstances\', apiKey);\n            setInstances(data || []);\n        } catch (error: any) {\n            toast({ title: \"Error fetching instances\", description: error.message, variant: \"destructive\" });\n        } finally {\n            setIsLoading(false);\n        }\n    };\n\n    const handleCreateInstance = async (e: React.FormEvent) => {\n        e.preventDefault();\n        if (!apiKey || !instanceName) {\n            toast({ title: \"Missing fields\", description: \"API Key and Instance Name are required.\", variant: \"destructive\" });\n            return;\n        }\n        setIsLoading(true);\n        try {\n            await fetchFromEvolutionAPI(\'instance/create\', apiKey, {\n                method: \'POST\',\n                headers: { \'Content-Type\': \'application/json\' },\n                body: JSON.stringify({ instanceName, qrcode: true }),\n            });\n            toast({ title: \"Instance Created\", description: `Instance ${instanceName} is being set up.` });\n            setInstanceName(\'\');\n            await fetchInstances();\n        } catch (error: any) {\n            toast({ title: \"Error creating instance\", description: error.message, variant: \"destructive\" });\n        } finally {\n            setIsLoading(false);\n        }\n    };\n\n    const handleConnect = async (name: string) => {\n        if (!apiKey) return;\n        setIsInstanceLoading(prev => ({ ...prev, [name]: true }));\n        setQrCode(\'\');\n        try {\n            const data = await fetchFromEvolutionAPI(`instance/connect/${name}`, apiKey);\n            if (data.base64) {\n                setQrCode(data.base64);\n                toast({ title: \"Scan QR Code\", description: `Scan the code to connect ${name}.` });\n            }\n        } catch (error: any) {\n            toast({ title: \"Error connecting instance\", description: error.message, variant: \"destructive\" });\n        } finally {\n            setIsInstanceLoading(prev => ({ ...prev, [name]: false }));\n        }\n    };\n    \n    const handleLogout = async (name: string) => {\n        if (!apiKey) return;\n        setIsInstanceLoading(prev => ({ ...prev, [name]: true }));\n        try {\n            await fetchFromEvolutionAPI(`instance/logout/${name}`, apiKey, { method: \'DELETE\' });\n            toast({ title: \"Instance Logged Out\", description: `Successfully disconnected ${name}.` });\n            await fetchInstances();\n        } catch (error: any) {\n            toast({ title: \"Error logging out\", description: error.message, variant: \"destructive\" });\n        } finally {\n            setIsInstanceLoading(prev => ({ ...prev, [name]: false }));\n        }\n    };\n\n    useEffect(() => {\n        if (apiKey) {\n            fetchInstances();\n        }\n    }, [apiKey]);\n\n    return (\n        <Card>\n            <CardHeader>\n                <CardTitle>Evolution API Instance Manager</CardTitle>\n                <CardDescription>Manage your WhatsApp instances. Enter your API key to begin.</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n                <div className=\"space-y-2\">\n                    <Label htmlFor=\"apiKey\">API Key</Label>\n                    <Input id=\"apiKey\" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder=\"Enter your API Key\" />\n                </div>\n\n                {apiKey && (\n                    <>\n                        <form onSubmit={handleCreateInstance} className=\"flex items-end gap-2\">\n                            <div className=\"flex-1\">\n                                <Label htmlFor=\"instanceName\">New Instance Name</Label>\n                                <Input id=\"instanceName\" value={instanceName} onChange={(e) => setInstanceName(e.target.value)} placeholder=\"e.g., my-business-whatsapp\" />\n                            </div>\n                            <Button type=\"submit\" disabled={isLoading}>{isLoading ? <Loader2 className=\"h-4 w-4 animate-spin\"/> : \'Create\'}</Button>\n                        </form>\n\n                        <div className=\"space-y-4\">\n                            <h3 className=\"text-md font-medium\">Available Instances</h3>\n                             {isLoading && <div className=\"flex items-center gap-2\"><Loader2 className=\"h-4 w-4 animate-spin\"/> Loading instances...</div>}\n                            <div className=\"space-y-2\">\n                                {instances.map(({ instance }) => (\n                                    <div key={instance.instanceName} className=\"flex items-center justify-between rounded-md border p-3\">\n                                        <div>\n                                            <span className=\"font-medium\">{instance.instanceName}</span>\n                                            <Badge variant={instance.status === \'open\' ? \'default\' : \'secondary\'} className={\`ml-2 ${instance.status === \'open\' ? \'bg-green-100 text-green-800\' : \'\'}\`}>\n                                                {instance.status}\n                                            </Badge>\n                                        </div>\n                                        <div className=\"flex items-center gap-2\">\n                                            {instance.status !== \'open\' && (\n                                                <Button size=\"sm\" variant=\"outline\" onClick={() => handleConnect(instance.instanceName)} disabled={isInstanceLoading[instance.instanceName]}>\n                                                    {isInstanceLoading[instance.instanceName] ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <QrCode className=\"h-4 w-4\"/>}\n                                                </Button>\n                                            )}\n                                            {instance.status === \'open\' && (\n                                                 <Button size=\"sm\" variant=\"destructive\" onClick={() => handleLogout(instance.instanceName)} disabled={isInstanceLoading[instance.instanceName]}>\n                                                     {isInstanceLoading[instance.instanceName] ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <Power className=\"h-4 w-4\"/>}\n                                                 </Button>\n                                            )}\n                                        </div>\n                                    </div>\n                                ))}\n                            </div>\n                        </div>\n\n                        {qrCode && (\n                            <div className=\"text-center space-y-2\">\n                                <h4 className=\"font-medium\">Scan to Connect</h4>\n                                <img src={`data:image/png;base64,${qrCode}`} alt=\"QR Code\" className=\"mx-auto border p-2\" />\n                                <Button variant=\"link\" onClick={() => setQrCode(\'\')}>Close QR</Button>\n                            </div>\n                        )}\n                    </>\n                )}\n            </CardContent>\n        </Card>\n    );\n}